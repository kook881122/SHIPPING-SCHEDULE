<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Shipping Schedule ì…ë ¥</title>

<style>
/* ===== ê¸°ë³¸ ìŠ¤íƒ€ì¼ ===== */
body { font-family:'Segoe UI',Arial,sans-serif; background:#f5f7fb; }
.container {
  max-width:700px; margin:30px auto; background:white;
  padding:30px 40px; border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,0.1);
}
h2 { margin-bottom:5px; font-size:24px; color:#333; }
.notice { color:#d10000; font-size:14px; margin-bottom:15px; font-weight:600; }
label { font-weight:600; margin-bottom:4px; display:block; }
label.required { color:#d10000; }
input[type=text], select, textarea {
  width:100%; padding:9px 12px; border-radius:8px;
  border:1px solid #ccc; box-sizing:border-box;
  margin-bottom:15px; font-size:14px;
}
textarea { resize:vertical; }
button {
  background:#3064ff; color:white; padding:12px 20px;
  border:none; border-radius:8px; font-size:15px; cursor:pointer;
}
button:disabled { background:#a5b8ff; cursor:not-allowed; }
.file-area {
  border:1px dashed #b8bec9; background:#fafcff;
  padding:12px 14px; border-radius:8px; margin-bottom:20px;
}
.file-item {
  display:flex; align-items:center; background:#f1f3f7;
  padding:6px 8px; border-radius:6px; margin-bottom:6px;
}
.file-thumb {
  width:34px; height:34px; margin-right:10px;
  border:1px solid #ddd; border-radius:4px; object-fit:cover;
}
.file-remove {
  background:#e74c3c; color:#fff; border:none;
  padding:3px 8px; border-radius:4px; font-size:11px; cursor:pointer;
}

/* ===== ëª¨ë‹¬ ===== */
.modal { display:none; position:fixed; left:0; top:0; width:100%; height:100%;
  background:rgba(0,0,0,0.45); z-index:9999; }
.modal-content {
  background:#fff; padding:24px 26px; border-radius:12px;
  width:720px; max-height:80vh; margin:5% auto;
  box-shadow:0 6px 20px rgba(0,0,0,0.25);
  animation:fadeIn .25s ease-out; overflow-y:auto; font-size:14px;
}
.modal-title { font-size:18px; font-weight:700; margin-bottom:12px; }
.modal-buttons { margin-top:16px; text-align:right; }
.modal-buttons button { margin-left:8px; }
.summary-row { margin-bottom:4px; line-height:1.6; }
.summary-label { font-weight:600; color:#333; }

/* ì• ë‹ˆë©”ì´ì…˜ */
@keyframes fadeIn { from{opacity:0; transform:scale(.95);} to{opacity:1; transform:scale(1);} }

</style>
</head>

<body>
<div class="container">
  <h2>ğŸš¢ Shipping Schedule ì…ë ¥</h2>
  <div class="notice">ğŸ”´ ë¹¨ê°„ìƒ‰ í•­ëª©ì€ í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.</div>

  <label>ë°œì‹ ì ì´ë©”ì¼(Reply-To)</label>
  <input type="text" id="fld_sender" placeholder="ì—¬ê¸°ì— ì…ë ¥í•œ ì£¼ì†Œë¡œ ë‹µì¥ë©ë‹ˆë‹¤.">

  <label>ì´ë©”ì¼ ì œëª©</label>
  <input type="text" id="fld_subject" placeholder="ë¹„ì›Œë‘ë©´ 'SHIPPING SCHEDULE' ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.">

  <label>ì—‘ì…€ ë¶™ì—¬ë„£ê¸°</label>
  <textarea id="bulkInput" style="height:80px;" placeholder="ì—‘ì…€ A~Uì—´ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸°"></textarea>
  <button onclick="parseExcel()">ë¶™ì—¬ë„£ê¸° ì ìš©</button>

  <hr style="margin:25px 0;">

  <div id="formArea"></div>

  <!-- âœ… ë¹„ê³ ëŠ” headersì™€ ë¶„ë¦¬í•´ì„œ í•­ìƒ ë§¨ ì•„ë˜ -->
  <label class="required">ë¹„ê³  *</label>
  <textarea id="fld_note" style="height:120px;" placeholder="ë‹´ë‹¹ì ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ê¼­ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>

  <button id="submitBtn" onclick="submitForm()">ì œì¶œí•˜ê¸°</button>
  <div id="waitMsg" style="display:none; margin-top:10px;">ì œì¶œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤â€¦</div>
</div>

<!-- ëª¨ë‹¬ -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <div class="modal-title">ì œì¶œ ë‚´ìš© í™•ì¸</div>
    <div id="summaryArea"></div>

    <div id="confirmWait" style="display:none; margin-top:10px;">â³ ì œì¶œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤â€¦</div>

    <div class="modal-buttons">
      <button onclick="closeConfirmModal()">ì·¨ì†Œ</button>
      <button id="finalSubmitBtn" onclick="confirmSubmit()">ìµœì¢… ì œì¶œ</button>
    </div>
  </div>
</div>

<script>
let formData = null;
let fileStore = [];
let pendingData = null;

function toSafeId(s){ return "fld_" + s.replace(/[^a-zA-Z0-9ê°€-í£]/g,"_"); }
function isValidDate(v){
  const r=/^[0-9]{4}\.[0-9]{1,2}\.[0-9]{1,2}$/;
  if(!r.test(v)) return false;
  const p=v.split(".");
  const d=new Date(+p[0],+p[1]-1,+p[2]);
  return d.getFullYear()==+p[0] && d.getMonth()+1==+p[1] && d.getDate()==+p[2];
}
function isValidEmail(v){ return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v); }

google.script.run.withSuccessHandler(buildForm).loadFormData();

/* -----------------------------------------------------------
 *  í¼ ìƒì„±
 * ---------------------------------------------------------*/
function buildForm(data) {

  // âœ… headersëŠ” í•­ëª©ëª… ì‹œíŠ¸ ê·¸ëŒ€ë¡œ (ë¹„ê³  ì¡°ì‘ ì œê±°)
  formData = data;

  // í•„ìˆ˜ í•„ë“œ ëª©ë¡ (ë¹„ê³ ëŠ” ë³„ë„ textarea)
  const required = [
    "BULK/CNTR êµ¬ë¶„(100)",
    "BOOKING NO(100)",
    "CFS(CY)ì½”ë“œ",
    "CALL SIGN",
    "í•­êµ¬ì²­ì½”ë“œ",
    "ì¶œí•­ì¼(ETD)(8)"
  ];

  const dateFields = [
    "ì„œë¥˜ë§ˆê°ì¼(100)","CARGO ë§ˆê°ì¼(8)",
    "ì¶œí•­ì¼(ETD)(8)","ë„ì°©ì¼(ETA)(8)"
  ];

  let html = "";

  data.headers.forEach(function(h){
    const id = toSafeId(h);
    const req = required.indexOf(h) !== -1;
    const isDate = dateFields.indexOf(h) !== -1;

    html += '<label class="' + (req ? 'required' : '') + '">' + h + (req ? ' *' : '') + '</label>';

    if(isDate){
      html += '<input type="text" id="' + id + '" placeholder="2025.12.06">';
    }
    else if(data.codeMap && data.codeMap[h]){
      html += '<select id="' + id + '">';
      html += '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
      html += data.codeMap[h].map(function(d){
        return '<option value="' + d.code + '">' + d.code + ' | ' + d.detail + '</option>';
      }).join("");
      html += '</select>';
    }
    else{
      html += '<input type="text" id="' + id + '">';
    }
  });

  /* ë‹´ë‹¹ì ì´ë©”ì¼ */
  html += '<label class="required">ë‹´ë‹¹ì ì´ë©”ì¼ *</label>';
  html += '<select id="fld_manager_email">';
  html += '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
  html += (data.managers || []).map(function(m){
    return '<option value="' + m.email + '">' + m.team + ' - ' + m.name + '</option>';
  }).join("");
  html += '</select>';
  html += '<div style="margin-top:-10px; margin-bottom:15px; font-size:13px;">';
  html += 'â€» ì„ íƒí•œ ë‹´ë‹¹ì ì™¸ì— <b>ë¬¼ë¥˜íŒ€ ë‹´ë‹¹ì</b>ì—ê²Œë„ ìë™ìœ¼ë¡œ ë©”ì¼ì´ ì „ë‹¬ë©ë‹ˆë‹¤.';
  html += '</div>';

  /* ì¶”ê°€ CC */
  html += '<label>ì¶”ê°€ ì´ë©”ì¼ ìˆ˜ì‹ ì(CC)</label>';
  html += '<input type="text" id="fld_extra_emails" placeholder="aaa@naver.com, bbb@gmail.com">';

  /* íŒŒì¼ ì²¨ë¶€ */
  html += '<label>íŒŒì¼ ì²¨ë¶€</label>';
  html += '<div class="file-area">';
  html += '<input type="file" id="fld_files" multiple>';
  html += '<div id="fileList"></div>';
  html += '</div>';

  document.getElementById("formArea").innerHTML = html;
  initFileUI();
}

/* -----------------------------------------------------------
 *  íŒŒì¼ UI
 * ---------------------------------------------------------*/
function initFileUI(){
  fileStore=[];
  renderFiles();

  var f = document.getElementById("fld_files");
  if(!f) return;

  f.addEventListener("change",function(e){
    var files = e.target.files;
    for(var i=0;i<files.length;i++){
      fileStore.push(files[i]);
    }
    e.target.value="";
    renderFiles();
  });
}

function renderFiles(){
  const list=document.getElementById("fileList");
  if(!list) return;

  list.innerHTML="";
  fileStore.forEach((f,i)=>{
    const isImg=f.type.indexOf("image/")===0;
    const thumb=isImg? `<img src="${URL.createObjectURL(f)}" class="file-thumb">`
                      : `<div class="file-thumb" style="display:flex;align-items:center;justify-content:center;">ğŸ“„</div>`;
    list.innerHTML += `
      <div class="file-item">
        ${thumb}
        <div style="flex:1">${f.name}</div>
        <button class="file-remove" onclick="removeFile(${i})">ì‚­ì œ</button>
      </div>
    `;
  });
}

function removeFile(i){
  fileStore.splice(i,1);
  renderFiles();
}

/* -----------------------------------------------------------
 *  ì—‘ì…€ ë¶™ì—¬ë„£ê¸°
 * ---------------------------------------------------------*/
function parseExcel(){

  // âœ… formData ì•„ì§ ë¡œë“œ ì „ì´ë©´ ë§‰ê³  ì•ˆë‚´
  if(!formData || !formData.headers){
    alert("í¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    return;
  }

  const txt=document.getElementById("bulkInput").value.trim();
  if(!txt) return;

  const cols=txt.split("\n")[0].split("\t");

  formData.headers.forEach((h,i)=>{
    const el=document.getElementById(toSafeId(h));
    if(!el) return;

    const v=cols[i];
    if(!v) return;

    if(el.tagName==="SELECT"){
      [...el.options].forEach(o=>{
        if(o.value===v || o.text.indexOf(v)!==-1) el.value=o.value;
      });
    } else {
      el.value=v;
    }
  });

  document.getElementById("waitMsg").innerText = "ë¶™ì—¬ë„£ê¸° ì ìš© ì™„ë£Œ!";
  document.getElementById("waitMsg").style.display = "block";
  setTimeout(function(){
    document.getElementById("waitMsg").style.display = "none";
  }, 1500);
}

/* -----------------------------------------------------------
 *  ì œì¶œ 1ë‹¨ê³„: ê²€ì¦ í›„ ëª¨ë‹¬ í‘œì‹œ
 * ---------------------------------------------------------*/
function submitForm(){

  if(!formData || !formData.headers){
    alert("í¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    return;
  }

  const sender=document.getElementById("fld_sender").value.trim();
  const subject=document.getElementById("fld_subject").value.trim() || "SHIPPING SCHEDULE";

  if(sender && !isValidEmail(sender)){
    alert("ë°œì‹ ì ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  const required=[
    "BULK/CNTR êµ¬ë¶„(100)","BOOKING NO(100)","CFS(CY)ì½”ë“œ",
    "CALL SIGN","í•­êµ¬ì²­ì½”ë“œ","ì¶œí•­ì¼(ETD)(8)"
  ];

  const dateFields=["ì„œë¥˜ë§ˆê°ì¼(100)","CARGO ë§ˆê°ì¼(8)","ì¶œí•­ì¼(ETD)(8)","ë„ì°©ì¼(ETA)(8)"];

  for(const h of formData.headers){
    const id = toSafeId(h);
    const el = document.getElementById(id);
    if(!el) continue;

    const v = el.value.trim();

    if(required.indexOf(h)!==-1 && !v){
      alert(h + " ì€(ëŠ”) í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.");
      return;
    }

    if(dateFields.indexOf(h)!==-1 && v && !isValidDate(v)){
      alert(h + " ë‚ ì§œê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
      return;
    }
  }

  // âœ… ë¹„ê³  ë³„ë„ í•„ìˆ˜
  const note = document.getElementById("fld_note").value.trim();
  if(!note){
    alert("ë¹„ê³  ì€(ëŠ”) í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.");
    return;
  }

  const manager=document.getElementById("fld_manager_email").value.trim();
  if(!manager){
    alert("ë‹´ë‹¹ì ì´ë©”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    return;
  }

  const extra=document.getElementById("fld_extra_emails").value.trim();
  if(extra){
    for(const e of extra.split(",")){
      const t=e.trim();
      if(t && !isValidEmail(t)){
        alert("ì˜ëª»ëœ ì´ë©”ì¼: " + t);
        return;
      }
    }
  }

  // âœ… values = í•­ëª©ëª… 21ê°œë§Œ + ë‹´ë‹¹ì ì´ë©”ì¼
  const values = formData.headers.map(h => {
    const el = document.getElementById(toSafeId(h));
    return el ? el.value.trim() : "";
  });
  values.push(manager);

  document.getElementById("waitMsg").style.display="block";

  readFilesAsBase64().then(fileData=>{
    document.getElementById("waitMsg").style.display="none";

    pendingData = {
      values: values,
      extra: extra,
      note: note,
      sender: sender,
      subject: subject,
      fileData: fileData
    };

    showSummary(values, extra, note, sender, subject);
    showConfirmModal();
  });
}

function readFilesAsBase64(){
  return Promise.all(
    fileStore.map(f => new Promise(resolve=>{
      const r=new FileReader();
      r.onload=e=>{
        resolve({
          name:f.name, type:f.type,
          data:e.target.result.split(",")[1]
        });
      };
      r.readAsDataURL(f);
    }))
  );
}

/* -----------------------------------------------------------
 *  ìš”ì•½ í‘œì‹œ
 * ---------------------------------------------------------*/
function showSummary(values, extra, note, sender, subject){
  let html="";

  html+=`<div class="summary-row"><span class="summary-label">ì´ë©”ì¼ ì œëª©:</span> ${subject}</div>`;
  if(sender){
    html+=`<div class="summary-row"><span class="summary-label">ë°œì‹ ì ì´ë©”ì¼:</span> ${sender}</div>`;
  }

  html+=`<hr style="margin:10px 0;">`;

  formData.headers.forEach((h,i)=>{
    html+=`<div class="summary-row"><span class="summary-label">${h}:</span> ${values[i] || ""}</div>`;
  });

  html+=`<div class="summary-row"><span class="summary-label">ë‹´ë‹¹ì ì´ë©”ì¼:</span> ${values[values.length-1]}</div>`;

  if(extra){
    html+=`<div class="summary-row"><span class="summary-label">ì¶”ê°€ CC:</span> ${extra}</div>`;
  }

  // âœ… ë¹„ê³ ëŠ” ì—¬ê¸°ì„œ 1ë²ˆë§Œ í‘œì‹œ
  if(note){
    html+=`<div class="summary-row"><span class="summary-label">ë¹„ê³ :</span> ${String(note).replace(/\n/g,"<br>")}</div>`;
  }

  document.getElementById("summaryArea").innerHTML = html;
}

/* -----------------------------------------------------------
 *  ëª¨ë‹¬ í‘œì‹œ/ë‹«ê¸°
 * ---------------------------------------------------------*/
function showConfirmModal(){
  document.getElementById("confirmWait").style.display="none";
  document.getElementById("finalSubmitBtn").disabled=false;
  document.getElementById("confirmModal").style.display="block";
}
function closeConfirmModal(){
  document.getElementById("confirmModal").style.display="none";
}

/* -----------------------------------------------------------
 *  ìµœì¢… ì œì¶œ â†’ Apps Script í•¨ìˆ˜ í˜¸ì¶œ
 * ---------------------------------------------------------*/
function confirmSubmit(){
  if(!pendingData) return;

  document.getElementById("confirmWait").style.display="block";
  document.getElementById("finalSubmitBtn").disabled=true;

  google.script.run
    .withSuccessHandler(()=>{
      document.getElementById("confirmWait").style.display="none";
      closeConfirmModal();
      alert("ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    })
    .withFailureHandler(err=>{
      document.getElementById("confirmWait").style.display="none";
      document.getElementById("finalSubmitBtn").disabled=false;
      alert("ì œì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err);
    })
    .submitData(
      pendingData.values,
      pendingData.extra,
      pendingData.note,
      pendingData.fileData,
      pendingData.sender,
      pendingData.subject
    );
}
</script>

</body>
</html>
